From 1291004d1d3e223a9213a2d5b144976a714cb203 Mon Sep 17 00:00:00 2001
From: Prabhu Sundararaj <b36876@freescale.com>
Date: Mon, 11 Feb 2013 10:45:55 -0600
Subject: [PATCH] add i.MX6 EGL support.

---
 src/plugins/platforms/eglfs/qeglfsscreen.cpp |   11 +++++++++--
 src/plugins/platforms/eglfs/qeglfsscreen.h   |    2 ++
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/plugins/platforms/eglfs/qeglfsscreen.cpp b/src/plugins/platforms/eglfs/qeglfsscreen.cpp
index 84bb984..9bd7c08 100644
--- a/src/plugins/platforms/eglfs/qeglfsscreen.cpp
+++ b/src/plugins/platforms/eglfs/qeglfsscreen.cpp
@@ -104,6 +104,12 @@ QEglFSScreen::QEglFSScreen(EGLNativeDisplayType display)
         qWarning("Could not bind GL_ES API\n");
         qFatal("EGL error");
     }
+    
+    int width, height;
+    mNativeDisplay = fbGetDisplayByIndex(0);
+    fbGetDisplayGeometry(mNativeDisplay, &width, &height);
+    mScreenSize.setHeight(height);
+    mScreenSize.setWidth(width);
 
     m_dpy = eglGetDisplay(display);
     if (m_dpy == EGL_NO_DISPLAY) {
@@ -164,14 +170,15 @@ void QEglFSScreen::createAndSetPlatformContext()
     EGLConfig config = q_configFromQPlatformWindowFormat(m_dpy, platformFormat);
 
     EGLNativeWindowType eglWindow = 0;
-#ifdef Q_OPENKODE
+/*#ifdef Q_OPENKODE
     if (kdInitializeNV() == KD_ENOTINITIALIZED) {
         qFatal("Did not manage to initialize openkode");
     }
     KDWindow *window = kdCreateWindow(m_dpy,config,0);
 
     kdRealizeWindow(window,&eglWindow);
-#endif
+#endif*/
+    eglWindow = fbCreateWindow(mNativeDisplay, 0, 0, mScreenSize.width(), mScreenSize.height());
 
     m_surface = eglCreateWindowSurface(m_dpy, config, eglWindow, NULL);
     if (m_surface == EGL_NO_SURFACE) {
diff --git a/src/plugins/platforms/eglfs/qeglfsscreen.h b/src/plugins/platforms/eglfs/qeglfsscreen.h
index 3208a9d..8915811 100644
--- a/src/plugins/platforms/eglfs/qeglfsscreen.h
+++ b/src/plugins/platforms/eglfs/qeglfsscreen.h
@@ -74,6 +74,8 @@ private:
     QPlatformGLContext *m_platformContext;
     EGLDisplay m_dpy;
     EGLSurface m_surface;
+    EGLNativeDisplayType mNativeDisplay;
+    QSize mScreenSize;
 };
 
 QT_END_NAMESPACE
-- 
1.7.9.5

